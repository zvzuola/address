/**
 * Created by AX on 2018/9/18.
 */

// import * as altizure from './altizure';
import boundary from '@/datas/boundary';
import { addProjects } from '@/utils/altizureUtil';

const { altizure } = window;

export default function init() {
  let gs;

  // 下城中点 lng: 120.172, lat: 30.309
  // lng: 120.1836688, lat: 30.33083
  // let centerPosition = { lng: 120.1836688, lat: 30.33083, z: 0 }
  // let centerPosition = { lng: 120.1836588, lat: 30.3305158, z: 0 } //原有备份
  // let centerPosition = { lng: 120.1836588, lat: 30.3305247, z: 0 } // ok  section1-2017的中心点位
  const centerPosition = { lng: 120.1766745, lat: 30.3132158, z: 0 }; // altizure ok section2的中心点位
  const basePosition = { lng: 120.172, lat: 30.309, z: 0 };
  const options = {
    altizureApi: {
      key: 'qwKCxUxTywiAlenHoNfhVzRuGA76O7EEYPyC4Av',
      altitoken:
        'CMr4tRB3i9f0hBF7Oz9gR5KoNYBtAKjogCh55mPhdXJgnPZNFz1rG1HBtWLdKgDwHLqaD1KCWOJpPxQlCULR5salA4qsPEmQGTo7mtGeZ5o5QCo7y6CjYomE3SKa'
    },
    camera: {
      poseTo: {
        alt: 50000000,
        lat: basePosition.lat,
        lng: basePosition.lng
      }
    },
    renderItems: {
      earth: true,
      earthUseTexture: true,
      featureInView: false,
      orbitRing: true
    }
  };

  const sandbox = new altizure.Sandbox('page-content', options);

  const projs = [
    {
      // section 2
      pid: '5bcefd4cfef3856e462eb247',
      center: { x: 516583.851635767671, y: 3355089.36604579818, z: 0 },
      // center: { x: 120.172425541000050, y: 30.315397042000029, z: 0 },
      boundary: [
        [120.1922595460727, 30.322559363774076],
        [120.19241958416626, 30.322515898230392],
        [120.19369007216108, 30.322654432628042],
        [120.19628094381449, 30.32262752468108],
        [120.19973224423984, 30.322869436553447],
        [120.20071744904044, 30.32263896430237],
        [120.20204792030461, 30.322690564011623],
        [120.20251804822806, 30.322612226972865],
        [120.20272806479534, 30.322507947966642],
        [120.20162204398764, 30.3212449489788],
        [120.19703586485446, 30.316485966167022],
        [120.19442008245369, 30.316334894274632],
        [120.19328992015551, 30.316673908090024],
        [120.1928983084839, 30.315498329795616],
        [120.1908390220749, 30.316136295009414],
        [120.19028321885139, 30.314482288304816],
        [120.18582042145954, 30.315051189414532],
        [120.18517409075639, 30.311977258798322],
        [120.18531273167616, 30.31178452337997],
        [120.18544239255777, 30.310725182869533],
        [120.18367956694624, 30.310584531640927],
        [120.18371420695144, 30.306890120339403],
        [120.18239031681549, 30.306760245041175],
        [120.17341736936248, 30.304418855411427],
        [120.16482275620956, 30.301392181011977],
        [120.16114223884222, 30.29985578480313],
        [120.16052888957825, 30.301623839489082],
        [120.15943559777963, 30.303314221255903],
        [120.15254274489371, 30.310491465601785],
        [120.15218483657293, 30.311316744338853],
        [120.15280489328507, 30.31227868863357],
        [120.1602082185758, 30.321967230688927],
        [120.16411322493491, 30.326334828149868],
        [120.17225976158284, 30.32332307823748],
        [120.17225976158284, 30.322590204247717],
        [120.17821793194162, 30.324692458046343],
        [120.18285907063341, 30.32586493745697],
        [120.18938831163337, 30.32615523169966],
        [120.19848247337688, 30.326471001204595],
        [120.19839805720096, 30.325557406168002],
        [120.19802742381103, 30.32450685613469],
        [120.19218026183648, 30.324356842204566],
        [120.1922595460727, 30.322559363774076]
      ].map((lnglat) => new altizure.LngLatAlt(lnglat[0], lnglat[1], 0)),
      marker: null
    },
    {
      // section 1-2017
      pid: '5bcef9bdfef3856e462eb169',
      center: { x: 516974.094270384347, y: 3356132.28479076177, z: 0 },
      // center:{x:120.1836588,y:30.3305158,z:0},
      boundary: [
        [120.2077703596068, 30.343422904775593],
        [120.20768116604484, 30.334536387388937],
        [120.20557063432238, 30.334589650543364],
        [120.20183322749108, 30.33469022020404],
        [120.20163455905231, 30.332230689674248],
        [120.20103493487898, 30.330136763989117],
        [120.19954063336729, 30.3285472840372],
        [120.19848353627299, 30.326508200677438],
        [120.198482473377, 30.326471001204766],
        [120.18938831163359, 30.32615523169983],
        [120.18869350901991, 30.326098124635678],
        [120.18285907063364, 30.32586493745714],
        [120.18118036089425, 30.325311117907972],
        [120.17821793194162, 30.324692458046513],
        [120.17225976158284, 30.322590204247888],
        [120.17225976158284, 30.32332307823765],
        [120.16411322493491, 30.326334828150095],
        [120.16485291495746, 30.32791025514001],
        [120.17147151107326, 30.335850764985537],
        [120.17802698645619, 30.3446230962752],
        [120.17847156864309, 30.344200197029465],
        [120.17875710396379, 30.344063378021588],
        [120.1788701283615, 30.344009840148942],
        [120.17832880098263, 30.34345661546513],
        [120.17894746084414, 30.343141336881786],
        [120.17936386652013, 30.343563691210363],
        [120.17976837489141, 30.34366853621094],
        [120.18052766397614, 30.343672165466444],
        [120.18207858667472, 30.343680342438233],
        [120.18207387431744, 30.344014152922057],
        [120.1831779442241, 30.344019371873173],
        [120.18317710843667, 30.34369452389069],
        [120.186954978676, 30.343698331028406],
        [120.18728731303906, 30.343722708606435],
        [120.18728969250014, 30.343460967895908],
        [120.18905288380085, 30.343463780244463],
        [120.18905287310542, 30.343099289822987],
        [120.18981430062718, 30.343115946049977],
        [120.19032112582136, 30.34312308443299],
        [120.19083270993758, 30.343113566588897],
        [120.19103020520117, 30.34324205748328],
        [120.19117535232249, 30.34360135609512],
        [120.19198431438485, 30.34359381821332],
        [120.19203433774555, 30.343836922734738],
        [120.19304525301618, 30.343812533259552],
        [120.19311901630749, 30.343852984096543],
        [120.19436585261224, 30.343851556419907],
        [120.19568621678684, 30.343865753870773],
        [120.19629428381029, 30.34386199035646],
        [120.19629297934318, 30.34317689990951],
        [120.19629190434932, 30.342538415171703],
        [120.19792484344418, 30.34252492759373],
        [120.19792421459954, 30.3436822696666],
        [120.19972150081253, 30.3436822696666],
        [120.19972269054313, 30.34457218808268],
        [120.20076132527231, 30.34457218808268],
        [120.20110396765699, 30.343355093778257],
        [120.20256793280953, 30.343354081048062],
        [120.2025679310409, 30.34397315877459],
        [120.20347164972873, 30.34397342434579],
        [120.20347165033127, 30.34308621468466],
        [120.20465661751837, 30.34308732683968],
        [120.20465662161894, 30.343835744901412],
        [120.20664109239101, 30.343835736041456],
        [120.20664109239101, 30.343422908416926],
        [120.2077703596068, 30.343422904775593]
      ].map((lnglat) => new altizure.LngLatAlt(lnglat[0], lnglat[1], 0)),
      marker: null
    },
    {
      // section 1-2018
      pid: '5bcef7aafef3856e462eb0bd',
      center: { x: 517723.991579999973, y: 3357834.54997999966, z: 0 },
      // center:{x:120.1836588,y:30.3305158,z:0},
      boundary: [
        [120.2077703596068, 30.343422904775593],
        [120.20664109239101, 30.343422908416926],
        [120.20664109239101, 30.343835736041456],
        [120.20465662161894, 30.343835744901412],
        [120.20465661751837, 30.34308732683968],
        [120.20347165033127, 30.34308621468466],
        [120.20347164972873, 30.34397342434579],
        [120.2025679310409, 30.34397315877459],
        [120.20256793280953, 30.343354081048062],
        [120.20110396765699, 30.343355093778257],
        [120.20076132527231, 30.34457218808268],
        [120.19972269054313, 30.34457218808268],
        [120.19972150081253, 30.3436822696666],
        [120.19792421459954, 30.3436822696666],
        [120.19792484344418, 30.34252492759373],
        [120.19629190434932, 30.342538415171703],
        [120.19629428381029, 30.34386199035646],
        [120.19568621678684, 30.343865753870773],
        [120.19436585261224, 30.343851556419907],
        [120.19311901630749, 30.343852984096543],
        [120.19304525301618, 30.343812533259552],
        [120.19203433774555, 30.343836922734738],
        [120.19198431438485, 30.34359381821332],
        [120.19117535232249, 30.34360135609512],
        [120.19103020520117, 30.34324205748328],
        [120.19083270993758, 30.343113566588897],
        [120.19032112582136, 30.34312308443299],
        [120.18905287310542, 30.343099289822987],
        [120.18905288380085, 30.343463780244463],
        [120.18728969250014, 30.343460967895908],
        [120.18728731303906, 30.343722708606435],
        [120.186954978676, 30.343698331028406],
        [120.18317710843667, 30.34369452389069],
        [120.1831779442241, 30.344019371873173],
        [120.18207387431744, 30.344014152922057],
        [120.18207858667472, 30.343680342438233],
        [120.17976837489141, 30.34366853621094],
        [120.17936386652013, 30.343563691210363],
        [120.17894746084414, 30.343141336881786],
        [120.17832880098263, 30.34345661546513],
        [120.1788701283615, 30.344009840148942],
        [120.17847156864309, 30.344200197029465],
        [120.17802698645619, 30.3446230962752],
        [120.17857269880426, 30.345353351401968],
        [120.18080906026682, 30.347912507604462],
        [120.1814372379722, 30.349133171100448],
        [120.1829291600227, 30.35025389723421],
        [120.18460668003195, 30.350689338598272],
        [120.18766432282678, 30.35060865326375],
        [120.1916521297477, 30.351558295228074],
        [120.19530454159633, 30.353367932135427],
        [120.19641876397725, 30.350757076867467],
        [120.19737904812848, 30.350070768610635],
        [120.19840466169853, 30.35003132856457],
        [120.19992467084217, 30.348120447339227],
        [120.20781420880621, 30.34779168056224],
        [120.2077703596068, 30.343422904775593]
      ].map((lnglat) => new altizure.LngLatAlt(lnglat[0], lnglat[1], 0)),
      marker: null
    },
    {
      // section3 还没有跑完数据
      pid: '5bcefe8efef3856e462eb282',
      center: { x: 516570.832947459246, y: 3352762.15073452843, z: 0 },
      boundary: [
        [120.17944529187059, 30.285567740802946],
        [120.17658003789006, 30.285137210412017],
        [120.17237315083162, 30.284680353898864],
        [120.17098354560414, 30.284509032706467],
        [120.16451141166817, 30.283976033441263],
        [120.16078041681124, 30.283423998487876],
        [120.1559636728357, 30.282376880232334],
        [120.15523506360898, 30.28510877564122],
        [120.14957629087132, 30.290350259924082],
        [120.14874381566563, 30.292008690769364],
        [120.1487845924056, 30.292049150052947],
        [120.15391588900161, 30.293793965203633],
        [120.15447777524264, 30.293983732583172],
        [120.15483591960833, 30.29387364339567],
        [120.16111084596673, 30.29595952109446],
        [120.16151861985361, 30.296495571904643],
        [120.1615245463845, 30.297476710797582],
        [120.16114223884222, 30.29985578480313],
        [120.16205306359848, 30.300264316495145],
        [120.16482275620956, 30.301392181011977],
        [120.17066195351765, 30.30347658885313],
        [120.17341736936248, 30.304418855411427],
        [120.17683665482775, 30.305311153288642],
        [120.1805129220819, 30.30627483499603],
        [120.18239031681549, 30.306760245041175],
        [120.18371420695144, 30.306890120339403],
        [120.18371831416164, 30.30669460399639],
        [120.18332180672076, 30.304448790987067],
        [120.18516862102013, 30.30447361727778],
        [120.1854161899023, 30.304405277908927],
        [120.18705915229691, 30.304591997518685],
        [120.18746707719072, 30.304915599097455],
        [120.18771761874359, 30.304986342571624],
        [120.18860355001095, 30.30504908927935],
        [120.18866115602725, 30.305019068705235],
        [120.18864948427517, 30.3046390889005],
        [120.1867756608001, 30.300690469096196],
        [120.18618955882528, 30.300176557100542],
        [120.18523981672831, 30.299701342240212],
        [120.18528338559804, 30.299304280167576],
        [120.18519597268312, 30.29922337839787],
        [120.18474725579824, 30.298778377435383],
        [120.18432192645173, 30.29859134267099],
        [120.18416468036082, 30.29870771125968],
        [120.18234980587613, 30.29797725878484],
        [120.18113364504097, 30.29279051436032],
        [120.18084240270082, 30.292825984749925],
        [120.17942717370022, 30.286655470696473],
        [120.17944529187059, 30.285567740802946]
      ].map((lnglat) => new altizure.LngLatAlt(lnglat[0], lnglat[1], 0)),
      marker: null
    },
    {
      // section4
      pid: '5bd66870fef3856e462ebb16',
      center: { x: 516375.501013977395, y: 3350220.91171889473, z: 0 },
      // center: { x: 120.170183446000010, y: 30.271483710000041, z: 0 },
      boundary: [
        [120.18485481086873, 30.274976658955097],
        [120.18470918743651, 30.27492610509978],
        [120.18461596417319, 30.27483508502172],
        [120.18455767393641, 30.274693464315305],
        [120.18296748289481, 30.274314477007294],
        [120.18408976021635, 30.268716807403678],
        [120.18353526560725, 30.260157975519064],
        [120.18106579440746, 30.26036064410016],
        [120.16871427408853, 30.260327392141107],
        [120.15929831278493, 30.260742663320173],
        [120.15406541168545, 30.26062433559298],
        [120.14995353511836, 30.274955639784537],
        [120.1532682186654, 30.27510965946334],
        [120.15622406444811, 30.2753245789429],
        [120.15610525697798, 30.275750277024486],
        [120.15616354229621, 30.276534299249192],
        [120.15718284630577, 30.27721206697487],
        [120.1559636728357, 30.282376880232334],
        [120.16078041681124, 30.283423998487876],
        [120.16451141166817, 30.283976033441263],
        [120.17098354560414, 30.284509032706467],
        [120.17237315083162, 30.284680353898864],
        [120.17658003789006, 30.285137210412017],
        [120.17944529187059, 30.285567740802946],
        [120.17976639426615, 30.28398107314007],
        [120.18187429239651, 30.28032398974517],
        [120.18282632534397, 30.27918820534569],
        [120.18376943881958, 30.277685660336374],
        [120.18419432312692, 30.276785178009106],
        [120.18459007161084, 30.275803764886575],
        [120.18485481086873, 30.274976658955097]
      ].map((lnglat) => new altizure.LngLatAlt(lnglat[0], lnglat[1], 0)),
      marker: null
    }
  ];

  return Promise.all(addProjects(sandbox, projs))
    .then(() => {
      // use the first project as the base
      const baseMarker = projs[0].marker;
      const baseCenter = projs[0].center;
      baseMarker.position = centerPosition;
      sandbox.lights.ambient.intensity = 0.01; // ambient light intensity

      gs = new altizure.GeoSystem({
        sandbox,
        base: baseMarker,
        baseCenter,
        EPSG: '4549'
      });

      // align other projects to the base project
      for (let pi = 1; pi < projs.length; pi += 1) {
        gs.align({ marker: projs[pi].marker, markerCenter: projs[pi].center });
      }
      // return sandbox.camera.lookAt(baseMarker, 0, 40, 15000)
      return sandbox.camera.flyTo({
        lng: basePosition.lng,
        lat: basePosition.lat,
        alt: 300000,
        north: 0,
        tilt: 40
      });
    })
    .then(() => {
      projs.forEach((proj) => {
        proj.marker.crop(boundary, false);
      });
      sandbox.camera.flyTo({
        lng: basePosition.lng,
        lat: basePosition.lat,
        alt: 15000,
        north: 0,
        tilt: 40
      });
      return { sandbox, gs };
    });
}
